# 사용자 인증 기능 가이드

## ✅ 구현 완료된 기능

### Service System (Django 서버)

1. **회원가입 API**
   - 엔드포인트: `POST /api_root/register/`
   - 인증 불필요 (AllowAny)
   - 자동으로 토큰 생성 및 반환

2. **로그인 API**
   - 엔드포인트: `POST /api-token-auth/`
   - 인증 불필요 (AllowAny)
   - 토큰 반환

3. **인증 필수 설정**
   - Post API: 인증 필수 (`IsAuthenticated`)
   - WellbeingLog API: 인증 필수 (`IsAuthenticated`)

### Edge System (wellbeing_analyzer.py)

1. **회원가입 기능**
   - 사용자명, 이메일, 비밀번호 입력
   - 자동으로 토큰 저장

2. **로그인 기능**
   - 사용자명, 비밀번호 입력
   - 자동으로 토큰 저장

3. **로그인 정보 저장**
   - 파일: `auth_info.json` (프로젝트 루트)
   - localhost에 저장
   - 다음 실행 시 자동 로드

4. **토큰 검증**
   - 매번 접속 시 토큰 유효성 확인
   - 만료된 토큰 자동 삭제 및 재로그인 요청

---

## 🚀 사용 방법

### 1단계: Django 서버 실행

```bash
python manage.py runserver
```

### 2단계: Wellbeing Analyzer 실행

```bash
python wellbeing_analyzer.py
```

### 3단계: 회원가입 또는 로그인

**첫 실행 시:**
```
============================================================
  사용자 인증 확인
============================================================

로그인이 필요합니다.

[1] 회원가입
[2] 로그인

선택하세요 (1 또는 2): 1

=== 회원가입 ===
사용자명: testuser
이메일 (선택사항): test@example.com
비밀번호: password123
비밀번호 확인: password123
✅ 회원가입 성공! 토큰이 저장되었습니다.
```

**다음 실행 시:**
```
============================================================
  사용자 인증 확인
============================================================
✅ 저장된 로그인 정보 사용: testuser
```

---

## 📁 저장된 로그인 정보

**파일 위치:** `auth_info.json` (프로젝트 루트)

**내용:**
```json
{
  "username": "testuser",
  "token": "abc123def456...",
  "saved_at": "2025-01-19T10:30:00"
}
```

---

## 🔐 API 엔드포인트

### 회원가입
```http
POST http://127.0.0.1:8000/api_root/register/
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123",
  "password_confirm": "password123"
}
```

### 로그인
```http
POST http://127.0.0.1:8000/api-token-auth/
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

### 인증이 필요한 API
- `POST /api_root/Post/` - 인증 토큰 필요
- `POST /api_root/WellbeingLog/` - 인증 토큰 필요
- `GET /api_root/Post/` - 인증 토큰 필요
- `GET /api_root/WellbeingLog/` - 인증 토큰 필요

---

## 🔄 동작 흐름

```
1. Wellbeing Analyzer 실행
   ↓
2. auth_info.json 파일 확인
   ↓
3. 토큰이 있으면 유효성 검증
   ↓
4. 토큰이 없거나 만료되었으면
   → 회원가입 또는 로그인 선택
   → 토큰 받아서 auth_info.json에 저장
   ↓
5. API 호출 시 저장된 토큰 사용
   ↓
6. 다음 실행 시 저장된 토큰 자동 사용
```

---

## 🧪 테스트 방법

### 1. 회원가입 테스트

```bash
python wellbeing_analyzer.py
# [1] 선택 → 회원가입 정보 입력
```

### 2. 로그인 테스트

```bash
python wellbeing_analyzer.py
# [2] 선택 → 로그인 정보 입력
```

### 3. 저장된 토큰 확인

```bash
# auth_info.json 파일 확인
cat auth_info.json  # Linux/Mac
type auth_info.json  # Windows CMD
Get-Content auth_info.json  # PowerShell
```

### 4. API 직접 테스트

```bash
# 회원가입
curl -X POST http://127.0.0.1:8000/api_root/register/ \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@test.com","password":"test123","password_confirm":"test123"}'

# 로그인
curl -X POST http://127.0.0.1:8000/api-token-auth/ \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"test123"}'
```

---

## ⚠️ 주의사항

1. **auth_info.json 파일 보안**
   - 토큰이 평문으로 저장되므로 보안에 주의
   - Git에 커밋하지 않도록 `.gitignore`에 추가 권장

2. **토큰 만료**
   - 토큰이 만료되면 자동으로 재로그인 요청
   - 수동으로 삭제하려면 `auth_info.json` 파일 삭제

3. **비밀번호**
   - 최소 8자 이상 권장
   - Django 기본 비밀번호 검증 규칙 적용

---

## 🐛 문제 해결

### 문제 1: "인증 토큰이 없어 요청이 실패할 수 있습니다"

**원인:** 로그인하지 않았거나 토큰이 만료됨

**해결:**
1. `python wellbeing_analyzer.py` 실행
2. 로그인 또는 회원가입

### 문제 2: "저장된 토큰이 만료되었습니다"

**원인:** 토큰이 서버에서 삭제되었거나 만료됨

**해결:**
1. 자동으로 재로그인 요청
2. 또는 `auth_info.json` 파일 삭제 후 재로그인

### 문제 3: 회원가입 실패

**확인 사항:**
- 사용자명이 이미 존재하는지 확인
- 비밀번호가 8자 이상인지 확인
- 비밀번호와 비밀번호 확인이 일치하는지 확인

---

## 📝 요약

✅ **구현 완료:**
- 회원가입 API (Service System)
- 로그인 API (Service System)
- 로그인 정보 localhost 저장 (Edge System)
- 저장된 토큰 자동 사용 (Edge System)
- 매번 접속 시 로그인 확인 (Edge System)
- 토큰 검증 및 만료 처리 (Edge System)

이제 Edge System에서 매번 접속할 때마다 로그인 인증을 통해 안전하게 API를 사용할 수 있습니다!

